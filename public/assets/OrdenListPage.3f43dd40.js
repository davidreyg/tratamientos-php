import{aE as X,aF as Y,W as K,Y as M,r as x,k as z,$ as Z,a0 as b,b0 as T,aU as B,a1 as ee,ag as ae,H as j,o as _,e as p,w as t,a5 as a,ad as v,aW as te,aX as Q,f as E,ac as S,aj as V,aS as ie,a2 as n,au as F,aa as se,b1 as oe,b2 as ne,ak as le,am as D,ae as re,a6 as ue,b3 as ce,al as de}from"./index.aead979f.js";import{u as me}from"./establecimientoFetchAllQuery.0c4bcf21.js";import{u as fe,_ as _e}from"./ExamenCardList.114af499.js";import{O as W}from"./OrdenApi.bfe1c23a.js";import{u as be}from"./paqueteFetchAllQuery.97c2b17e.js";import{_ as ve}from"./BaseCheckBoxGroup.9dadbd8a.js";import{u as pe,_ as ge}from"./OrdenTable.b23457c8.js";import{u as G}from"./laboratorio.store.31b4110a.js";import"./PaqueteApi.84f21d74.js";import"./BaseTable.29e35e3b.js";function ye(g,y){const s=async()=>(await W.fetchById(g.value)).data().data,{data:l,isLoading:d,isSuccess:r,isError:u,isFetching:C,refetch:$}=X([Y.ORDEN_ALL,g.value],s,{enabled:y});return{data:l,isLoading:d,isSuccess:r,isError:u,isFetching:C,refetch:$}}function qe(){return K(({id:g,data:y})=>W.update(g,y))}const he={class:"col-12"},xe={class:"col-12"},Ee={class:"col-12 row q-col-gutter-sm"},Ce=M({__name:"OrdenEditForm",props:{orden:{type:Object,required:!0}},emits:["submit","cancel"],setup(g,{emit:y}){const s=g,l=y,d=x({limit:0,search:"is_active:1",searchJoin:"and"}),{data:r}=fe(d),{data:u}=be(),C=z(()=>u.value?u.value.map(e=>({label:e.nombre,value:Number(e.id)})):[]),$=x({limit:0}),{data:k}=me($),P=z(()=>k.value?k.value.map(e=>({label:e.nombre,value:Number(e.id)})):[]),L=Z().shape({diagnostico:b().trim().min(2).required().label("Diagnostico"),CI10:b().trim().min(2).required().label("CI10"),CPN:b().trim().min(2).required().label("CPN"),EG:b().trim().min(2).required().label("EG"),codigo_atencion:b().trim().min(2).required().label("Codigo de Atencion"),fecha_registro:b().trim().required().label("Fecha de Registro"),medico:b().trim().required().label("M\xE9dico"),examen_ids:T().of(B().required()).required().label("Examenes"),item_ids:T().of(B().required()).required().label("Items"),paquete_ids:T().of(B().required()).required().label("Paquetes"),establecimiento_id:B().when([],{is:()=>h.value===!0,then:e=>e.required(),otherwise:e=>e.nullable()}).label("Establecimiento Institucional"),establecimiento_otro:b().when([],{is:()=>h.value===!1,then:e=>e.required(),otherwise:e=>e.nullable()}).label("Otro Establecimiento")}),{values:q,setFieldValue:w,handleSubmit:I}=ee({validationSchema:L,initialValues:{...s.orden,paquete_ids:[]}}),h=x(!!s.orden.establecimiento_id),{mutateAsync:o,reset:A,isLoading:m}=qe(),U=I(async(e,{setErrors:i,resetForm:c})=>{await o({id:s.orden.id,data:e},{onSuccess:()=>{ae.success("Orden Actualizada correctamente."),c(),l("submit")},onError:f=>{A.value(),i(f.data.errors)}})},e=>{console.log(e)});j(()=>q.examen_ids,e=>{var i;if(e){const c=(i=u.value)==null?void 0:i.filter(N=>N.examen_ids.every(O=>e.includes(O)));w("paquete_ids",(c==null?void 0:c.map(N=>Number(N.id)))||[]);let f=[];r.value&&(f=[],e.forEach(N=>{const O=r.value.find(R=>Number(R.id)===N);if(O&&O.items.data.length>0){const R=O.items.data.map(J=>Number(J.id));f.push(...R)}}),w("item_ids",[...new Set(f)]),console.log(q.item_ids))}});const H=e=>{var i;if(e){const c=(i=u.value)==null?void 0:i.filter(f=>e.includes(Number(f.id))).map(f=>f.examen_ids).flat();w("examen_ids",[...new Set(c)])}};return(e,i)=>(_(),p(se,{loading:n(m),onSubmit:n(U),onCancel:i[2]||(i[2]=c=>e.$emit("cancel"))},{default:t(()=>[a(v,{name:"medico",label:"Medico",class:"col-xs-12 col-sm-6",required:""}),h.value?(_(),p(te,{key:0,options:P.value,name:"establecimiento_id",class:"col-xs-12 col-sm-6",label:"Establecimiento Institucional",loading:!1,required:""},{after:t(()=>[a(S,{round:"",flat:"",icon:"fas fa-building-circle-arrow-right",color:"primary",onClick:i[0]||(i[0]=c=>h.value=!1)},{default:t(()=>[a(Q,null,{default:t(()=>[E(" Otro establecimiento ")]),_:1})]),_:1})]),_:1},8,["options"])):(_(),p(v,{key:1,name:"establecimiento_otro",label:"Otro establecimiento",class:"col-xs-12 col-sm-6",required:""},{after:t(()=>[a(S,{round:"",flat:"",icon:"fas fa-building-circle-xmark",color:"negative",onClick:i[1]||(i[1]=c=>h.value=!0)},{default:t(()=>[a(Q,null,{default:t(()=>[E(" Establecimiento institucional")]),_:1})]),_:1})]),_:1})),a(v,{name:"diagnostico",label:"Diagnostico",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"CI10",label:"CI10",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"CPN",label:"CPN",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"EG",label:"EG",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"codigo_atencion",label:"Codigo de Atenci\xF3n",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"fecha_registro",label:"Fecha de Registro",class:"col-xs-12 col-sm-4",type:"date",required:""}),V("div",he,[a(ie,{spaced:""}),E(" Paquetes")]),V("div",xe,[a(ve,{name:"paquete_ids",label:"Paquetes",options:C.value,onUpdate:H},null,8,["options"])]),V("div",Ee,[n(r)?(_(),p(_e,{key:0,examens:n(r)},null,8,["examens"])):F("",!0)])]),_:1},8,["loading","onSubmit"]))}}),$e={class:"row q-col-gutter-md"},ke={class:"col-12"},Ve=M({__name:"OrdenListPage",setup(g){const{$reset:y}=G(),{ordenSeleccionada:s}=oe(G()),l=x({}),d=x(0),r=x(""),{data:u,isFetching:C,refetch:$}=pe(l),{data:k,isFetching:P,refetch:L}=ye(d,!!d.value),q=x("list"),w=o=>{l.value.page=o.pagination.page,l.value.limit=o.pagination.rowsPerPage,l.value.search=o.filter,l.value.orderBy=o.pagination.sortBy,l.value.sortedBy=o.pagination.descending?"desc":"asc"},I=async()=>{s.value=void 0,await $.value()},h=async o=>{s.value=void 0,d.value=o,r.value="edit",await L.value(),k.value&&(s.value=k.value,q.value="edit-orden")};return ne(()=>{y()}),j(()=>s.value,o=>{o||(q.value="list")}),(o,A)=>(_(),le("div",$e,[V("div",ke,[a(de,{modelValue:q.value,"onUpdate:modelValue":A[0]||(A[0]=m=>q.value=m),animated:""},{default:t(()=>[a(D,{name:"list"},{default:t(()=>[n(u)?(_(),p(ge,{key:0,ordens:n(u).data,"server-pagination":n(u).meta.pagination,loading:n(C),onRequest:w},{"custom-actions":t(({props:m})=>[m.row.estado===0?(_(),p(S,{key:0,color:"warning",icon:"fas fa-edit",round:"",flat:"",size:"sm",loading:r.value==="edit"&&n(P)&&d.value===Number(m.key),onClick:U=>h(Number(m.key))},{default:t(()=>[a(Q,null,{default:t(()=>[E("Editar Orden.")]),_:1})]),_:2},1032,["loading","onClick"])):F("",!0),a(S,{color:"primary",icon:"fas fa-eye",round:"",flat:"",size:"sm",loading:r.value==="view"&&n(P)&&d.value===Number(m.key)},{default:t(()=>[a(Q,null,{default:t(()=>[E("Visualizar Orden.")]),_:1})]),_:2},1032,["loading"]),m.row.estado===2?(_(),p(S,{key:1,color:"info",icon:"fas fa-print",round:"",flat:"",size:"sm"},{default:t(()=>[a(Q,null,{default:t(()=>[E("Imprimir.")]),_:1})]),_:1})):F("",!0)]),_:1},8,["ordens","server-pagination","loading"])):F("",!0)]),_:1}),a(D,{name:"edit-orden"},{default:t(()=>[n(s)?(_(),p(ce,{key:0,icon:"fas fa-file-signature",label:"Datos de la orden."},{default:t(()=>[a(re,{class:"my-card"},{default:t(()=>[a(ue,null,{default:t(()=>[a(Ce,{orden:n(s),onSubmit:I,onCancel:I},null,8,["orden"])]),_:1})]),_:1})]),_:1})):F("",!0)]),_:1})]),_:1},8,["modelValue"])])]))}});export{Ve as default};
