import{aH as W,aI as X,W as K,Y as M,r as x,k as D,$ as Z,a0 as b,b6 as T,aV as B,a1 as ee,ag as ae,H as j,o as _,e as p,w as t,a5 as a,ad as v,aX as te,aY as Q,f as C,ac as S,aj as V,aD as ie,a2 as n,au as F,aa as se,ba as oe,bb as ne,ak as le,am as U,ae as re,a6 as ce,al as ue}from"./index.822d49dc.js";import{u as de}from"./establecimientoFetchAllQuery.4c730622.js";import{u as me}from"./examenFetchAllQuery.3ea7dbae.js";import{O as H}from"./OrdenApi.5298003c.js";import{u as fe}from"./paqueteFetchAllQuery.4ba9d2b9.js";import{_ as _e}from"./ExamenCardList.adc71097.js";import{_ as be}from"./BaseCheckBoxGroup.84b3022d.js";import{u as ve,_ as pe}from"./OrdenTable.6d5a6fc0.js";import{u as G}from"./laboratorio.store.732864b1.js";import"./EstablecimientoApi.cc507ab5.js";import"./ExamenApi.ab8fee7c.js";import"./PaqueteApi.5bf234d5.js";import"./BaseTable.b0153d26.js";function ge(g,y){const s=async()=>(await H.fetchById(g.value)).data().data,{data:l,isLoading:d,isSuccess:r,isError:c,isFetching:E,refetch:$}=W([X.ORDEN_ALL,g.value],s,{enabled:y});return{data:l,isLoading:d,isSuccess:r,isError:c,isFetching:E,refetch:$}}function ye(){return K(({id:g,data:y})=>H.update(g,y))}const he={class:"col-12"},qe={class:"col-12"},xe={class:"col-12 row q-col-gutter-sm"},Ce=M({__name:"OrdenEditForm",props:{orden:{type:Object,required:!0}},emits:["submit","cancel"],setup(g,{emit:y}){const s=g,l=y,d=x({limit:0,search:"is_active:1",searchJoin:"and"}),{data:r}=me(d),{data:c}=fe(),E=D(()=>c.value?c.value.map(e=>({label:e.nombre,value:Number(e.id)})):[]),$=x({limit:0}),{data:k}=de($),P=D(()=>k.value?k.value.map(e=>({label:e.nombre,value:Number(e.id)})):[]),L=Z().shape({diagnostico:b().trim().min(2).required().label("Diagnostico"),CI10:b().trim().min(2).nullable().label("CI10"),CPN:b().trim().min(2).nullable().label("CPN"),EG:b().trim().min(2).nullable().label("EG"),codigo_atencion:b().trim().min(2).required().label("Codigo de Atencion"),fecha_registro:b().trim().required().label("Fecha de Registro"),medico:b().trim().required().label("M\xE9dico"),examen_ids:T().of(B().required()).required().label("Examenes"),item_ids:T().of(B().required()).required().label("Items"),paquete_ids:T().of(B().required()).required().label("Paquetes"),establecimiento_id:B().when([],{is:()=>q.value===!0,then:e=>e.required(),otherwise:e=>e.nullable()}).label("Establecimiento Institucional"),establecimiento_otro:b().when([],{is:()=>q.value===!1,then:e=>e.required(),otherwise:e=>e.nullable()}).label("Otro Establecimiento")}),{values:h,setFieldValue:w,handleSubmit:I}=ee({validationSchema:L,initialValues:{...s.orden,paquete_ids:[]}}),q=x(!!s.orden.establecimiento_id),{mutateAsync:o,reset:A,isLoading:m}=ye(),z=I(async(e,{setErrors:i,resetForm:u})=>{await o({id:s.orden.id,data:e},{onSuccess:()=>{ae.success("Orden Actualizada correctamente."),u(),l("submit")},onError:f=>{A.value(),i(f.data.errors)}})},e=>{console.log(e)});j(()=>h.examen_ids,e=>{var i;if(e){const u=(i=c.value)==null?void 0:i.filter(N=>N.examen_ids.every(O=>e.includes(O)));w("paquete_ids",(u==null?void 0:u.map(N=>Number(N.id)))||[]);let f=[];r.value&&(f=[],e.forEach(N=>{const O=r.value.find(R=>Number(R.id)===N);if(O&&O.items.data.length>0){const R=O.items.data.map(J=>Number(J.id));f.push(...R)}}),w("item_ids",[...new Set(f)]),console.log(h.item_ids))}});const Y=e=>{var i;if(e){const u=(i=c.value)==null?void 0:i.filter(f=>e.includes(Number(f.id))).map(f=>f.examen_ids).flat();w("examen_ids",[...new Set(u)])}};return(e,i)=>(_(),p(se,{loading:n(m),onSubmit:n(z),onCancel:i[2]||(i[2]=u=>e.$emit("cancel"))},{default:t(()=>[a(v,{name:"medico",label:"Medico",class:"col-xs-12 col-sm-6",required:""}),q.value?(_(),p(te,{key:0,options:P.value,name:"establecimiento_id",class:"col-xs-12 col-sm-6",label:"Establecimiento Institucional",loading:!1,required:""},{after:t(()=>[a(S,{round:"",flat:"",icon:"fas fa-building-circle-arrow-right",color:"primary",onClick:i[0]||(i[0]=u=>q.value=!1)},{default:t(()=>[a(Q,null,{default:t(()=>[C(" Otro establecimiento ")]),_:1})]),_:1})]),_:1},8,["options"])):(_(),p(v,{key:1,name:"establecimiento_otro",label:"Otro establecimiento",class:"col-xs-12 col-sm-6",required:""},{after:t(()=>[a(S,{round:"",flat:"",icon:"fas fa-building-circle-xmark",color:"negative",onClick:i[1]||(i[1]=u=>q.value=!0)},{default:t(()=>[a(Q,null,{default:t(()=>[C(" Establecimiento institucional")]),_:1})]),_:1})]),_:1})),a(v,{name:"diagnostico",label:"Diagnostico",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"CI10",label:"CI10",class:"col-xs-12 col-sm-4"}),a(v,{name:"CPN",label:"Codigo Pre Natal",class:"col-xs-12 col-sm-4"}),a(v,{name:"EG",label:"Edad Gestacional",class:"col-xs-12 col-sm-4"}),a(v,{name:"codigo_atencion",label:"Codigo de Atenci\xF3n",class:"col-xs-12 col-sm-4",required:""}),a(v,{name:"fecha_registro",label:"Fecha de Registro",class:"col-xs-12 col-sm-4",type:"date",required:""}),V("div",he,[a(ie,{spaced:""}),C(" Paquetes")]),V("div",qe,[a(be,{name:"paquete_ids",label:"Paquetes",options:E.value,onUpdate:Y},null,8,["options"])]),V("div",xe,[n(r)?(_(),p(_e,{key:0,examens:n(r)},null,8,["examens"])):F("",!0)])]),_:1},8,["loading","onSubmit"]))}}),Ee={class:"row q-col-gutter-md"},$e={class:"col-12"},Re=M({__name:"OrdenListPage",setup(g){const{$reset:y}=G(),{ordenSeleccionada:s}=oe(G()),l=x({}),d=x(0),r=x(""),{data:c,isFetching:E,refetch:$}=ve(l),{data:k,isFetching:P,refetch:L}=ge(d,!!d.value),h=x("list"),w=o=>{l.value.page=o.pagination.page,l.value.limit=o.pagination.rowsPerPage,l.value.search=o.filter,l.value.orderBy=o.pagination.sortBy,l.value.sortedBy=o.pagination.descending?"desc":"asc"},I=async()=>{s.value=void 0,await $.value()},q=async o=>{s.value=void 0,d.value=o,r.value="edit",await L.value(),k.value&&(s.value=k.value,h.value="edit-orden")};return ne(()=>{y()}),j(()=>s.value,o=>{o||(h.value="list")}),(o,A)=>(_(),le("div",Ee,[V("div",$e,[a(ue,{modelValue:h.value,"onUpdate:modelValue":A[0]||(A[0]=m=>h.value=m),animated:""},{default:t(()=>[a(U,{name:"list"},{default:t(()=>[n(c)?(_(),p(pe,{key:0,ordens:n(c).data,"server-pagination":n(c).meta.pagination,loading:n(E),onRequest:w},{"custom-actions":t(({props:m})=>[m.row.estado===0?(_(),p(S,{key:0,color:"warning",icon:"fas fa-edit",round:"",flat:"",size:"sm",loading:r.value==="edit"&&n(P)&&d.value===Number(m.key),onClick:z=>q(Number(m.key))},{default:t(()=>[a(Q,null,{default:t(()=>[C("Editar Orden.")]),_:1})]),_:2},1032,["loading","onClick"])):F("",!0),a(S,{color:"primary",icon:"fas fa-eye",round:"",flat:"",size:"sm",loading:r.value==="view"&&n(P)&&d.value===Number(m.key)},{default:t(()=>[a(Q,null,{default:t(()=>[C("Visualizar Orden.")]),_:1})]),_:2},1032,["loading"]),m.row.estado===2?(_(),p(S,{key:1,color:"info",icon:"fas fa-print",round:"",flat:"",size:"sm"},{default:t(()=>[a(Q,null,{default:t(()=>[C("Imprimir.")]),_:1})]),_:1})):F("",!0)]),_:1},8,["ordens","server-pagination","loading"])):F("",!0)]),_:1}),a(U,{name:"edit-orden"},{default:t(()=>[a(re,{class:"my-card"},{default:t(()=>[a(ce,null,{default:t(()=>[n(s)?(_(),p(Ce,{key:0,orden:n(s),onSubmit:I,onCancel:I},null,8,["orden"])):F("",!0)]),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])])]))}});export{Re as default};
